// ========================================
// ГЕНЕРАТОР И ДАННЫЕ - Generator & Datasource
// ========================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ========================================
// ENUMS - Перечисления
// ========================================

enum Role {
  DEVELOPER
  ADMIN
  SUPERVISOR
  EMPLOYEE
}

enum AccessLevel {
  READONLY
  CONTRIBUTOR
  FULL
}

enum NotificationType {
  INFO
  WARNING
  ERROR
  SUCCESS
  ALERT
  SYSTEM
  EVENT
}

enum NotificationChannel {
  IN_APP
  EMAIL
  PUSH
  TELEGRAM
}

enum NotificationPriority {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum RocTypeByTerm {
  Urgent
  Extended
  Perpetual
  LongTerm
}

enum Activity {
  On
  Off
}


enum AppCategory {
  MOBILE      // Мобильные приложения
  DESKTOP     // Десктопные приложения
  UTILITY     // Утилиты
  TOOL        // Инструменты
}

enum AppType {
  ANDROID_APK // Android APK
  WINDOWS_EXE // Windows EXE
  WINDOWS_MSI // Windows MSI
  MACOS_DMG   // macOS DMG
  LINUX_DEB   // Linux DEB
  LINUX_RPM   // Linux RPM
  ARCHIVE     // Архив (ZIP, RAR)
}

enum BugReportErrorType {
  CRASH                 // Критическая ошибка (краш приложения)
  NETWORK_ERROR         // Ошибка сети
  AUTHENTICATION_ERROR  // Ошибка аутентификации
  MEDIA_ERROR           // Ошибка воспроизведения
  DOWNLOAD_ERROR        // Ошибка загрузки
  PERMISSION_ERROR      // Ошибка разрешений
  STORAGE_ERROR         // Ошибка хранилища
  SOCKET_ERROR          // Ошибка Socket.IO
  PERFORMANCE_ISSUE     // Проблема производительности
  UNKNOWN_ERROR         // Неизвестная ошибка
}

enum BugReportSeverity {
  LOW       // Низкая - не влияет на работу
  MEDIUM    // Средняя - частично влияет на работу
  HIGH      // Высокая - серьезно влияет на работу
  CRITICAL  // Критическая - приложение не работает
}

enum NetworkType {
  WiFi      // WiFi
  Mobile    // Мобильная сеть
  Ethernet  // Ethernet
}

// ========================================
// СПРАВОЧНИКИ - Reference Data
// ========================================

// Организационная структура
model Branch {
  uuid          String         @id @default(uuid())
  division      String
  code          String
  rrs           String
  name          String
  status        Int
  city          String
  address       String
  last_update   DateTime
  latitude      Float
  longitude     Float
  totalArea     Int
  tradingArea   Int
  warehouseArea Int
  type          String
  typeOfDist    String?
  images        BranchImage[]
  devices       Devices[]
  printService  PrintService[] @relation("BranchPrint")
  rk            RK[]
  supplyDocs    SupplyDocs[]   @relation("SupplyDocs_Branch")
  userData      UserData[]
  shops         Shop[]
  shopRequests  ShopRequest[]  @relation("ShopRequestRequesterBranch")
}

model Group {
  uuidPosition      String
  name              String            @unique
  uuid              String            @id @default(uuid())
  groupToolAccesses GroupToolAccess[]
  positions         Position[]
}

model Position {
  groupUuid            String
  name                 String               @unique
  uuid                 String               @id @default(uuid())
  group                Group                @relation(fields: [groupUuid], references: [uuid])
  positionToolAccesses PositionToolAccess[]
  userData             UserData[]
}

// Типы и категории
model Type {
  id                     String         @id @default(uuid())
  model_uuid             String
  chapter                String
  name                   String
  colorHex               String?
  parent_type            String?
  parent                 Type?          @relation("TypeHierarchy", fields: [parent_type], references: [id], onDelete: Cascade)
  children               Type[]          @relation("TypeHierarchy")
  sortOrder              Int            @default(0)
  Media                  Media[]        @relation("TypeMedia")
  rk_approvalStatus      RKAttachment[] @relation("RK_approvalStatus")
  rk_typeStructure       RKAttachment[] @relation("RK_typeStructure")
  roc_statusContract     Roc[]          @relation("Roc_statusContract")
  roc_typeContract       Roc[]          @relation("Roc_typeContract")
  SupplyDocsPTiU         SupplyDocs[]   @relation("SupplyDocs_PTiU")
  SupplyDocsRequirements SupplyDocs[]   @relation("SupplyDocs_Requirements")
  Tool                   Tool           @relation(fields: [model_uuid], references: [id])
  shops                  Shop[]
  correspondenceSenderTypes      Correspondence[]  @relation("CorrespondenceSenderType")
  correspondenceSenderSubTypes   Correspondence[]  @relation("CorrespondenceSenderSubType")
  correspondenceSenderSubSubTypes Correspondence[] @relation("CorrespondenceSenderSubSubType")
  correspondenceDocumentTypes    Correspondence[]  @relation("CorrespondenceDocumentType")

  @@index([parent_type])
  @@index([model_uuid, chapter])
  @@index([model_uuid, chapter, sortOrder])
  @@index([parent_type, sortOrder])
}

// Инструменты и доступы
model Tool {
  id                   String               @id @default(uuid())
  parent_id            String?
  name                 String
  icon                 String
  link                 String
  description          String?
  order                Int                  @default(1)
  included             Boolean?             @default(true)
  groupToolAccesses    GroupToolAccess[]
  Notifications        Notifications[]
  positionToolAccesses PositionToolAccess[]
  types                Type[]
  userToolAccesses     UserToolAccess[]
}

// ========================================
// ПОЛЬЗОВАТЕЛИ И АУТЕНТИФИКАЦИЯ
// ========================================

model User {
  id                     String                     @id @default(uuid())
  name                   String
  email                  String                     @unique
  position               String
  branch                 String
  feedbackResponses      FeedbackResponse[]
  image                  String?
  login                  String                     @unique
  updatedAt              DateTime                   @updatedAt
  role                   Role                       @default(EMPLOYEE)
  telegramChatId         String?                    @unique
  telegramLinkToken      String?                    @unique
  telegramUsername       String?
  bookmarks              Bookmarks[]
  correspondences        Correspondence[]              @relation("CorrespondenceUser")
  correspondenceResponsible Correspondence[]          @relation("CorrespondenceResponsible")
  attachments            CorrespondenceAttachment[]
  MediaAdd               Media[]                    @relation("Media_UserAdd")
  MediaUpdated           Media[]                    @relation("Media_UserUpdated")
  MediaAttachment        MediaAttachment[]
  meterReadings          MeterReading[]
  news                   News[]
  Notifications_Receiver Notifications[]            @relation("receiver")
  Notifications_Sender   Notifications[]            @relation("sender")
  RKAdded                RK[]                       @relation("RK_UserAdd")
  RKUpdated              RK[]                       @relation("RK_UserUpdated")
  RKAttachment           RKAttachment[]
  RocAdded               Roc[]                      @relation("Roc_UserAdd")
  RocUpdated             Roc[]                      @relation("Roc_UserUpdated")
  RocAttachment          RocAttachment[]
  Slider_Add             Slider[]                   @relation("added")
  Slider_Updated         Slider[]                   @relation("updated")
  AddedSupplyDocs        SupplyDocs[]               @relation("SupplyDocs_AddedBy")
  SupplyDocs             SupplyDocs[]               @relation("SupplyDocs_SettlementSpecialist")
  SupplyDocsAttachments  SupplyDocsAttachment[]
  UserSettings           UserSettings[]
  userToolAccesses       UserToolAccess[]
  MerchAttachments       MerchAttachment[]
  auditLogs              AuditLog[]
  shops                  Shop[]
  shopRequests           ShopRequest[] @relation("ShopRequestRequester")
  scanSessions           ScanSession[]
  pollsCreated           Poll[]        @relation("PollCreator")
  pollVotes              PollVote[]    @relation("PollVoter")
}

model UserData {
  uuid        String   @id @default(uuid())
  birthday    DateTime
  fio         String
  code        String
  branch_uuid String
  positionId  String
  email       String   @unique
  status      String
  start_date  DateTime
  end_date    DateTime
  last_update DateTime @updatedAt
  branch      Branch   @relation(fields: [branch_uuid], references: [uuid])
  position    Position @relation(fields: [positionId], references: [uuid])
}

model UserSettings {
  id        String @id @default(uuid())
  userId    String
  parameter String
  value     String
  type      String
  user      User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, parameter])
}

model ScanSession {
  id          String       @id @default(uuid())
  userId      String
  printerIp   String
  printerPort Int
  folderName  String
  startedAt   DateTime     @default(now())
  stoppedAt   DateTime?
  status      String       @default("active") // active, completed, stopped
  user        User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  files       ScannedFile[]

  @@index([userId])
  @@index([startedAt])
}

model ScannedFile {
  id            String      @id @default(uuid())
  scanSessionId String
  fileName      String
  filePath      String
  fileSize      Int
  scannedAt     DateTime    @default(now())
  scanSession   ScanSession @relation(fields: [scanSessionId], references: [id], onDelete: Cascade)

  @@index([scanSessionId])
}

model Printer {
  id          String   @id @default(uuid())
  ip          String
  port        Int      @default(9100)
  name        String?
  vendor      String?
  model       String?
  hasScanner  Boolean  @default(false)
  scannerType String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([ip, port])
  @@index([ip])
  @@index([hasScanner])
}

// ========================================
// РЕГИСТРЫ - Operational Data
// ========================================

// Устройства и оборудование
model Devices {
  id           String   @id @default(uuid())
  createdAt    DateTime @default(now())
  lastSeen     DateTime @default(now())
  vendor       String
  name         String
  timeFrom     String   @default("08:00")
  timeUntil    String   @default("22:00")
  network      String
  number       String
  app          String
  os           String
  macAddress   String?
  branchId     String
  branch       Branch   @relation(fields: [branchId], references: [uuid])
  userEmail    String?  // Email пользователя для связи с UserData
}

// Уведомления
model Notifications {
  id         String                @id @default(uuid())
  type       NotificationType
  channel    NotificationChannel[]
  action     Json?
  title      String
  message    String
  senderId   String
  receiverId String
  read       Boolean               @default(false)
  toolId     String?
  priority   NotificationPriority  @default(MEDIUM)
  expiresAt  DateTime?
  createdAt  DateTime              @default(now())
  updatedAt  DateTime              @updatedAt
  receiver   User                  @relation("receiver", fields: [receiverId], references: [id])
  sender     User                  @relation("sender", fields: [senderId], references: [id])
  tool       Tool?                 @relation(fields: [toolId], references: [id])

  @@index([receiverId])
  @@index([read])
  @@index([createdAt])
  @@index([senderId])
  @@index([toolId])
}

// Новости
model News {
  id          String   @id @default(uuid())
  name        String
  description String
  userId      String
  createdAt   DateTime @default(now())
  user        User     @relation(fields: [userId], references: [id])
}

// Закладки
model Bookmarks {
  id         String  @id @default(uuid())
  name       String
  url        String  @unique
  userId     String
  order      Int     @default(0)
  user       User    @relation(fields: [userId], references: [id])
}

// Опросы
model Poll {
  id          String      @id @default(uuid())
  question    String
  isActive    Boolean     @default(true)
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  createdById String
  createdBy   User        @relation("PollCreator", fields: [createdById], references: [id])
  options     PollOption[]
  votes       PollVote[]

  @@index([isActive])
  @@index([createdAt])
}

model PollOption {
  id        String     @id @default(uuid())
  pollId    String
  poll      Poll       @relation(fields: [pollId], references: [id], onDelete: Cascade)
  text      String
  order     Int        @default(0)
  createdAt DateTime   @default(now())
  votes     PollVote[]

  @@index([pollId])
}

model PollVote {
  id        String      @id @default(uuid())
  pollId    String
  poll      Poll        @relation(fields: [pollId], references: [id], onDelete: Cascade)
  optionId  String
  option    PollOption  @relation(fields: [optionId], references: [id], onDelete: Cascade)
  userId    String
  user      User        @relation("PollVoter", fields: [userId], references: [id])
  createdAt DateTime    @default(now())

  @@unique([pollId, userId])
  @@index([pollId])
  @@index([optionId])
  @@index([userId])
}

// ========================================
// МОДУЛЬ AXO (Административно-хозяйственный отдел)
// ========================================

// Показания счетчиков
model MeterReading {
  id          String   @id @default(uuid())
  createdAt   DateTime @default(now())
  date        DateTime
  userId      String
  indications Json
  user        User     @relation(fields: [userId], references: [id])
}

// Корреспонденция
model Correspondence {
  id                    String                        @id @default(uuid())
  createdAt             DateTime                      @default(now())
  ReceiptDate           DateTime                      // Дата получения
  userAdd               String                        // Кто добавил запись
  senderTypeId          String                        // Тип отправителя (связь с Type)
  senderType            Type                          @relation("CorrespondenceSenderType", fields: [senderTypeId], references: [id])
  senderSubTypeId       String?                       // Подтип (только для суда: Федеральные суды / Мировые судьи)
  senderSubType         Type?                        @relation("CorrespondenceSenderSubType", fields: [senderSubTypeId], references: [id])
  senderSubSubTypeId    String?                       // Подподтип (только для федеральных судов)
  senderSubSubType      Type?                        @relation("CorrespondenceSenderSubSubType", fields: [senderSubSubTypeId], references: [id])
  senderName            String                        // Наименование отправителя / ФИО
  documentTypeId        String                        // Тип документа (связь с Type)
  documentType          Type                          @relation("CorrespondenceDocumentType", fields: [documentTypeId], references: [id])
  comments              String?                       // Комментарии (номер дела, ФИО стороны и т.д.)
  responsibleId         String                        // Ответственный за обработку
  responsible           User                          @relation("CorrespondenceResponsible", fields: [responsibleId], references: [id])
  // Старые поля для обратной совместимости (можно будет удалить после миграции данных)
  from                  String?                       @default("")
  to                    String?                       @default("")
  content               String?                       @default("")
  typeMail              String?                       @default("")
  numberMail            String?                       @default("")
  user                  User                          @relation("CorrespondenceUser", fields: [userAdd], references: [id])
  attachments           CorrespondenceAttachment[]
  
  @@index([ReceiptDate])
  @@index([senderTypeId])
  @@index([documentTypeId])
  @@index([responsibleId])
  @@index([userAdd])
}

model CorrespondenceAttachment {
  id             String         @id @default(uuid())
  createdAt      DateTime       @default(now())
  record_id      String
  userAdd        String
  source         String
  correspondence Correspondence @relation(fields: [record_id], references: [id], onDelete: Cascade)
  user           User           @relation(fields: [userAdd], references: [id])
}

// ========================================
// МОДУЛЬ СНАБЖЕНИЯ
// ========================================

// Маршруты
model Route {
  id         String     @id @default(uuid())
  name       String     @unique
  rrs        String
  contractor String
  createdAt  DateTime   @default(now())
  updatedAt  DateTime   @updatedAt
  filials    Filial[]
  days       RouteDay[]
}

model RouteDay {
  id        String   @id @default(uuid())
  day       DateTime @unique
  routeId   String
  createdAt DateTime @default(now())
  filials   Filial[]
  route     Route    @relation(fields: [routeId], references: [id], onDelete: Cascade)
}

model Filial {
  id         String    @id @default(uuid())
  name       String
  place      Int?
  accepted   Boolean   @default(false)
  feedback   String?
  routeId    String
  routeDayId String?
  updatedAt  DateTime  @updatedAt
  routeDay   RouteDay? @relation(fields: [routeDayId], references: [id], onDelete: Cascade)
  route      Route     @relation(fields: [routeId], references: [id], onDelete: Cascade)
  loaders    Loader[]
}

model Loader {
  id        String   @id @default(uuid())
  startTime DateTime
  endTime   DateTime
  filialId  String
  filial    Filial   @relation(fields: [filialId], references: [id], onDelete: Cascade)
}

// Документы снабжения
model SupplyDocs {
  id                     String                 @id @default(uuid())
  createdAt              DateTime               @default(now())
  updatedAt              DateTime
  addedById              String
  inn                    Int
  counterParty           String
  demandsForPayment      String
  statusRequirements     String
  fileInvoicePayment     String
  costBranchId           String
  settlementSpecialistId String?
  statusOfPTiU           String
  filePTiU               String
  note                   String
  fileNote               String
  requirementNumber      String
  addedBy                User                   @relation("SupplyDocs_AddedBy", fields: [addedById], references: [id])
  costBranch             Branch                 @relation("SupplyDocs_Branch", fields: [costBranchId], references: [uuid])
  settlementSpecialist   User?                  @relation("SupplyDocs_SettlementSpecialist", fields: [settlementSpecialistId], references: [id])
  statusOfPTiUId         Type                   @relation("SupplyDocs_PTiU", fields: [statusOfPTiU], references: [id])
  statusRequirementsId   Type                   @relation("SupplyDocs_Requirements", fields: [statusRequirements], references: [id])
  supplyDocs             SupplyDocsAttachment[]
}

model SupplyDocsAttachment {
  id         String     @id @default(uuid())
  createdAt  DateTime   @default(now())
  userAdd    String
  source     String
  type       String
  recordId   String
  supplyDocs SupplyDocs @relation(fields: [recordId], references: [id])
  user       User       @relation(fields: [userAdd], references: [id])
}

// ========================================
// МОДУЛЬ ДОБАВЛЕНИЯ КОНТЕНТА
// ========================================

// Медиа
model Media {
  id              String            @id @default(uuid())
  createdAt       DateTime          @default(now())
  updatedAt       DateTime?         @updatedAt
  userAddId       String
  userUpdatedId   String?
  name            String?
  information     String?
  urlMedia2       String?
  typeContentId   String?
  typeContent     Type?             @relation("TypeMedia", fields: [typeContentId], references: [id])
  userAdd         User              @relation("Media_UserAdd", fields: [userAddId], references: [id])
  userUpdated     User?             @relation("Media_UserUpdated", fields: [userUpdatedId], references: [id])
  MediaAttachment MediaAttachment[]
}

model MediaAttachment {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())
  userAddId String
  source    String
  type      String
  recordId  String
  media     Media    @relation(fields: [recordId], references: [id])
  userAdd   User     @relation(fields: [userAddId], references: [id])
}

// Рекламные конструкции
model RK {
  id            String         @id @default(uuid())
  createdAt     DateTime       @default(now())
  updatedAt     DateTime?      @updatedAt
  userAddId     String
  userUpdatedId String
  branchId      String
  branch        Branch         @relation(fields: [branchId], references: [uuid])
  userAdd       User           @relation("RK_UserAdd", fields: [userAddId], references: [id])
  userUpdated   User           @relation("RK_UserUpdated", fields: [userUpdatedId], references: [id])
  rkAttachment  RKAttachment[]
}

model RKAttachment {
  id                 String         @id @default(uuid())
  createdAt          DateTime       @default(now())
  userAddId          String
  source             String
  type               String
  recordId           String
  sizeXY             String
  clarification      String
  agreedTo           DateTime?
  approvalStatusId   String?
  typeStructureId    String?
  typeAttachment     String
  parentAttachmentId String?
  approvalStatus     Type?          @relation("RK_approvalStatus", fields: [approvalStatusId], references: [id])
  parentAttachment   RKAttachment?  @relation("RKAttachment_Parent", fields: [parentAttachmentId], references: [id])
  childAttachments   RKAttachment[] @relation("RKAttachment_Parent")
  rk                 RK             @relation(fields: [recordId], references: [id], onDelete: Cascade)
  typeStructure      Type?          @relation("RK_typeStructure", fields: [typeStructureId], references: [id])
  userAdd            User           @relation(fields: [userAddId], references: [id])
}

// Слайдер
model Slider {
  id          String    @id @default(uuid())
  addedById   String
  updatedById String?
  name        String
  category    String
  visible     Boolean   @default(false)
  timeVisible Float     @default(0)
  attachment  String
  startDate   DateTime?
  endDate     DateTime?
  url         String    @default("https://dns-shop.ru/")
  add         Boolean   @default(false)
  sale        Boolean   @default(false)
  order       Int       @default(1)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  addedBy     User      @relation("added", fields: [addedById], references: [id])
  updatedBy   User?     @relation("updated", fields: [updatedById], references: [id])
}

// ========================================
// МОДУЛЬ ЮРИДИЧЕСКОЙ СЛУЖБЫ
// ========================================

// Документы
model Doc {
  id              String    @id @default(uuid())
  fullName        String
  name            String
  address         String
  inn             String
  ogrn            String
  kpp             String
  taxationSystem  String
  phone           String
  email           String
  siEgrul         String
  statusCode      Int
  deStatusCode    String
  liquidationDate DateTime
  successorName   String
  successorINN    String
  updatedAt       DateTime? @updatedAt
  roc             Roc[]
}

// Реестр контрактов
model Roc {
  id                     String          @id @default(uuid())
  createdAt              DateTime        @default(now())
  updatedAt              DateTime?       @updatedAt
  userAddId              String
  userUpdatedId          String
  terminationLetter      Boolean         @default(false)
  dateSendCorrespondence DateTime
  docId                  String
  shelfLife              Int
  name                   String
  typeTerm               RocTypeByTerm
  contractNumber         String
  dateContract           DateTime
  agreedTo               DateTime
  typeContractId         String
  statusContractId       String
  terminationСonditions  String
  peculiarities          String
  folderNo               String
  doc                    Doc             @relation(fields: [docId], references: [id])
  statusContract         Type            @relation("Roc_statusContract", fields: [statusContractId], references: [id])
  typeContract           Type            @relation("Roc_typeContract", fields: [typeContractId], references: [id])
  userAdd                User            @relation("Roc_UserAdd", fields: [userAddId], references: [id])
  userUpdated            User            @relation("Roc_UserUpdated", fields: [userUpdatedId], references: [id])
  rocAttachment          RocAttachment[]
}

model RocAttachment {
  id         String   @id @default(uuid())
  createdAt  DateTime @default(now())
  source     String
  type       String
  recordId   String
  userAddId  String
  additional Boolean  @default(false)
  roc        Roc      @relation(fields: [recordId], references: [id])
  userAdd    User     @relation(fields: [userAddId], references: [id])
}

// ========================================
// МОДУЛЬ РОЗНИЧНОЙ ТОРГОВЛИ
// ========================================

// Печатные услуги
model PrintService {
  id        String   @id @default(uuid())
  branchId  String
  tovarName String
  tovarCode Int
  price     Float
  createdAt DateTime
  updatedAt DateTime
  brand     String
  tovarId   String
  format    Int
  branch    Branch   @relation("BranchPrint", fields: [branchId], references: [uuid])
}

// Магазин приложений
model App {
  id            String        @id @default(uuid())
  name          String        // Название приложения
  category      AppCategory   // Категория приложения
  appType       AppType       // Тип приложения
  description   String?       // Описание приложения
  icon          String?       // Путь к иконке
  isActive      Boolean       @default(true)
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  
  // Связи
  versions      AppVersion[]  // Версии приложения
  
  @@index([category])
  @@index([appType])
  @@index([isActive])
  @@index([createdAt])
}

// Модель версии приложения
model AppVersion {
  id          String   @id @default(uuid())
  appId       String   // ID приложения
  version     String   // Версия (например, "1.0.0")
  fileName    String   // Имя файла
  filePath    String   // Путь к файлу
  fileSize    Int      // Размер файла в байтах
  description String?  // Описание изменений в версии
  isActive    Boolean  @default(true) // Активная версия
  downloadCount Int    @default(0) // Количество скачиваний
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Связи
  app         App      @relation(fields: [appId], references: [id], onDelete: Cascade)
  
  @@index([appId])
  @@index([version])
  @@index([isActive])
  @@index([createdAt])
}

// ========================================
// МОДУЛЬ РАДИО
// ========================================

model RadioStream {
  id               String    @id @default(cuid())
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  name             String
  branchTypeOfDist String
  frequencySongs   Int
  fadeInDuration   Int
  volumeLevel      Int
  startDate        DateTime
  endDate          DateTime?
  attachment       String?
  isActive         Boolean   @default(true)

  @@map("RadioStream")
}

// Отчеты об ошибках DNS Radio
model BugReport {
  id                String              @id @default(uuid())
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt
  
  // Основная информация
  deviceId          String              // Уникальный ID устройства
  userId            String?             // ID пользователя
  userEmail         String?             // Email пользователя
  branchType        String?             // Тип филиала
  branchName        String?             // Название филиала
  
  // Информация об ошибке
  errorType         BugReportErrorType  // Тип ошибки
  errorMessage      String              // Описание ошибки
  stackTrace        String?             // Стек вызовов
  severity          BugReportSeverity   // Серьезность ошибки
  
  // Информация об устройстве
  appVersion        String              // Версия приложения
  androidVersion    String?             // Версия Android
  deviceModel       String?             // Модель устройства
  deviceManufacturer String?            // Производитель
  
  // Системная информация
  memoryUsage       Int?                // Использование памяти в MB
  storageFree       Int?                // Свободное место в MB
  networkType       NetworkType?        // Тип сети
  isOnline          Boolean?            // Статус подключения
  
  // Контекст
  userAction        String?             // Действие пользователя
  sessionId         String?             // ID сессии
  timestamp         DateTime            // Время ошибки
  
  // Дополнительные данные (JSON)
  additionalData    Json?               // Дополнительная информация
  
  // Статус
  isAutoReport      Boolean             @default(true)  // Автоматический отчет
  isResolved        Boolean             @default(false) // Решена ли ошибка
  resolvedAt        DateTime?           // Время решения
  resolvedBy        String?             // Кто решил
  resolutionNotes   String?             // Заметки о решении
  
  // Индексы для быстрого поиска
  @@index([deviceId])
  @@index([errorType])
  @@index([severity])
  @@index([isResolved])
  @@index([createdAt])
  @@index([timestamp])
  @@index([userEmail])
  @@index([branchType])
}

// ========================================
// МОДУЛЬ МЕРЧАНДАЙЗИНГА
// ========================================

model Merch {
  id          String   @id @default(uuid())
  parentId    String?
  parent      Merch?   @relation("CategoryHierarchy", fields: [parentId], references: [id], onDelete: Cascade)
  children    Merch[]  @relation("CategoryHierarchy")
  name        String
  description String?
  isActive    Boolean  @default(true) // ← новое поле
  sortOrder   Int      @default(0)    // ← порядок сортировки
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  layer       Int
  attachments MerchAttachment[]   // Связи с attachments

  // Индексы для оптимизации запросов
  @@index([parentId])
  @@index([layer])
  @@index([isActive])
  @@index([parentId, layer])
  @@index([sortOrder])
  @@index([parentId, sortOrder])
}

model MerchAttachment {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())
  userAddId String
  source    String
  type      String
  recordId  String
  sortOrder Int      @default(0)    // ← порядок сортировки
  merch     Merch    @relation(fields: [recordId], references: [id], onDelete: Cascade)
  userAdd   User     @relation(fields: [userAddId], references: [id])

  // Индексы для оптимизации запросов
  @@index([recordId])
  @@index([recordId, sortOrder])
  @@index([type])
}

// Telegram бот для мерча
model MerchTgUser {
  id        String   @id @default(uuid())
  userId    Int      @unique // Telegram user ID
  username  String?
  firstName String?
  lastName  String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  isActive  Boolean  @default(true)
  stats     MerchTgUserStats[]

  @@index([isActive])
}

model MerchTgUserStats {
  id        String       @id @default(uuid())
  userId    String
  action    String
  details   String?
  timestamp DateTime     @default(now())
  user      MerchTgUser @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Индексы для оптимизации запросов статистики
  @@index([userId])
  @@index([action])
  @@index([timestamp])
  @@index([userId, action])
  @@index([action, timestamp])
}

// ========================================
// ДОСКА ОБЪЯВЛЕНИЙ (AVITO-подобная)
// ========================================

enum ShopStatus {
  ACTIVE     // Активно
  SOLD       // Продано
  ARCHIVED   // Архивировано
  MODERATION // На модерации
}

enum ItemCondition {
  NEW        // Новое
  EXCELLENT  // Отличное
  GOOD       // Хорошее
  SATISFACTORY // Удовлетворительное
  POOR       // Плохое
}

model Shop {
  id          String      @id @default(uuid())
  title       String
  description String?     @db.Text
  categoryId  String
  category    Type        @relation(fields: [categoryId], references: [id])
  branchId    String
  branch      Branch      @relation(fields: [branchId], references: [uuid])
  status      ShopStatus  @default(ACTIVE)
  userId      String
  user        User        @relation(fields: [userId], references: [id])
  contactName String?
  contactPhone String?
  contactEmail String?
  views       Int         @default(0)
  isPromoted  Boolean     @default(false) // Платное продвижение
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  publishedAt DateTime?   // Дата публикации
  images      ShopImage[]
  items       ShopItem[]
  requests    ShopRequest[]

  @@index([categoryId])
  @@index([branchId])
  @@index([status])
  @@index([userId])
  @@index([createdAt])
  @@index([status, createdAt])
  @@index([isPromoted, status])
}

model ShopItem {
  id          String        @id @default(uuid())
  shopId      String
  shop        Shop          @relation(fields: [shopId], references: [id], onDelete: Cascade)
  name        String        // Наименование
  quantity    Int           @default(1) // Количество
  article     String?       // Артикул (необязателен)
  description String?       @db.Text // Описание
  condition   ItemCondition @default(GOOD) // Состояние
  sortOrder   Int           @default(0)
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  reserves    ShopItemReserve[] // Резервы по этому товару

  @@index([shopId])
  @@index([shopId, sortOrder])
}

model ShopImage {
  id        String   @id @default(uuid())
  shopId    String
  shop      Shop     @relation(fields: [shopId], references: [id], onDelete: Cascade)
  source    String   // Путь к файлу
  sortOrder Int      @default(0)
  isMain    Boolean  @default(false) // Главное изображение
  createdAt DateTime @default(now())

  @@index([shopId])
  @@index([shopId, sortOrder])
}

enum ShopRequestStatus {
  PENDING   // Ожидает подтверждения
  APPROVED // Подтвержден
  REJECTED // Отклонен
  COMPLETED // Завершен (документ отгрузки добавлен)
}

model ShopRequest {
  id              String          @id @default(uuid())
  shopId          String
  shop            Shop            @relation(fields: [shopId], references: [id], onDelete: Cascade)
  requesterId     String          // Кто запросил
  requester       User            @relation("ShopRequestRequester", fields: [requesterId], references: [id], onDelete: Cascade)
  requesterBranchId String?       // Филиал запросившего
  requesterBranch Branch?         @relation("ShopRequestRequesterBranch", fields: [requesterBranchId], references: [uuid], onDelete: SetNull)
  status          ShopRequestStatus @default(PENDING)
  shipmentDocNumber String?       // Номер документа отгрузки
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  approvedAt      DateTime?       // Дата подтверждения
  completedAt     DateTime?       // Дата завершения (когда добавлен номер документа)
  reserves        ShopItemReserve[] // Резервы по товарам

  @@index([shopId])
  @@index([requesterId])
  @@index([requesterBranchId])
  @@index([status])
  @@index([shopId, status])
}

model ShopItemReserve {
  id          String      @id @default(uuid())
  requestId   String
  request     ShopRequest @relation(fields: [requestId], references: [id], onDelete: Cascade)
  itemId      String
  item        ShopItem    @relation(fields: [itemId], references: [id], onDelete: Cascade)
  quantity    Int         // Количество в резерве
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  @@unique([requestId, itemId])
  @@index([requestId])
  @@index([itemId])
}

// Универсальная таблица обратной связи
enum FeedbackStatus {
  NEW         // Новое
  IN_PROGRESS // В работе
  RESOLVED    // Решено
  REJECTED    // Отклонено
}

enum FeedbackPriority {
  LOW      // Низкий
  MEDIUM   // Средний
  HIGH     // Высокий
  CRITICAL // Критический
}

model Feedback {
  id          String          @id @default(uuid())
  tool        String          // Инструмент/модуль (merch, radio, и т.д.)
  userId      String?         // ID пользователя (может быть из разных источников)
  email       String
  text        String
  photos      String[]        @default([]) // Массив путей к фотографиям
  metadata    Json?           // Дополнительные данные (имя пользователя, username и т.д.)
  createdAt   DateTime        @default(now())
  isRead      Boolean         @default(false)
  readAt      DateTime?
  readBy      String?         // ID пользователя системы, который прочитал
  
  // Новые поля для улучшений
  status      FeedbackStatus  @default(NEW)
  priority    FeedbackPriority @default(MEDIUM)
  tags        String[]        @default([]) // Теги/категории
  assignedTo  String?         // ID пользователя системы, назначенного для обработки
  pinned      Boolean         @default(false) // Закреплено ли сообщение
  responses   FeedbackResponse[] // Ответы на обратную связь
  
  @@index([tool])
  @@index([createdAt])
  @@index([isRead])
  @@index([tool, isRead])
  @@index([status])
  @@index([priority])
  @@index([assignedTo])
  @@index([pinned])
  @@index([email])
}

model FeedbackResponse {
  id          String   @id @default(uuid())
  feedbackId  String
  feedback    Feedback @relation(fields: [feedbackId], references: [id], onDelete: Cascade)
  userId      String   // ID пользователя системы, который ответил
  user        User     @relation(fields: [userId], references: [id])
  text        String   // Текст ответа
  createdAt   DateTime @default(now())
  sentAt      DateTime? // Когда был отправлен ответ (если отправлен по email)
  sentEmail   Boolean  @default(false) // Отправлен ли ответ по email
  
  @@index([feedbackId])
  @@index([createdAt])
  @@index([userId])
}

// ========================================
// СВЯЗУЮЩИЕ ТАБЛИЦЫ - Junction Tables
// ========================================

// Доступы к инструментам
model GroupToolAccess {
  id          String      @id @default(uuid())
  toolId      String
  accessLevel AccessLevel
  groupId     String
  group       Group       @relation(fields: [groupId], references: [uuid])
  tool        Tool        @relation(fields: [toolId], references: [id])

  @@unique([groupId, toolId], name: "groupId_toolId")
}

model PositionToolAccess {
  id          String      @id @default(uuid())
  toolId      String
  accessLevel AccessLevel
  positionId  String
  position    Position    @relation(fields: [positionId], references: [uuid])
  tool        Tool        @relation(fields: [toolId], references: [id])

  @@unique([positionId, toolId], name: "positionId_toolId")
}

model UserToolAccess {
  id          String      @id @default(uuid())
  userId      String
  toolId      String
  accessLevel AccessLevel
  tool        Tool        @relation(fields: [toolId], references: [id])
  user        User        @relation(fields: [userId], references: [id])

  @@unique([userId, toolId], name: "userId_toolId")
}

// Изображения филиалов
model BranchImage {
  id          String @id @default(uuid())
  link        String
  branch_uuid String
  branch      Branch @relation(fields: [branch_uuid], references: [uuid])
}

// Аудит действий пользователей
model AuditLog {
  id          String   @id @default(uuid())
  userId      String
  userEmail   String?
  action      String   // CREATE, UPDATE, DELETE, LOGIN, LOGOUT, etc.
  entityType  String?  // User, Tool, Branch, etc.
  entityId    String?  // ID сущности
  details     Json?    // Дополнительные детали действия
  ipAddress   String?
  userAgent   String?
  timestamp   DateTime @default(now())
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([action])
  @@index([entityType])
  @@index([timestamp])
  @@index([userId, timestamp])
}

// Логи открытия дверей Trassir
model TrassirDoorLog {
  id        String   @id @default(uuid())
  doorId    Int
  doorName  String?
  personName String?
  tgId      Int?
  openedAt  DateTime @default(now())

  @@index([doorId])
  @@index([tgId])
  @@index([openedAt])
  @@map("TrassirDoorLog")
}