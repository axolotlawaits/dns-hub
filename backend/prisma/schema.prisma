generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  // Примечание: Предупреждение о `url` относится к Prisma 7, текущая версия - 6.19.1
  // В Prisma 6 свойство `url` в datasource является корректным и необходимым
  url      = env("DATABASE_URL")
}

enum Role {
  DEVELOPER
  ADMIN
  SUPERVISOR
  EMPLOYEE
}

enum AccessLevel {
  READONLY
  CONTRIBUTOR
  FULL
}

enum NotificationType {
  INFO
  WARNING
  ERROR
  SUCCESS
  ALERT
  SYSTEM
  EVENT
}

enum NotificationChannel {
  IN_APP
  EMAIL
  PUSH
  TELEGRAM
}

enum NotificationPriority {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum RocTypeByTerm {
  Urgent
  Extended
  Perpetual
  LongTerm
}

enum Activity {
  On
  Off
}

enum AppCategory {
  MOBILE
  DESKTOP
  UTILITY
  TOOL
}

enum AppType {
  ANDROID_APK
  WINDOWS_EXE
  WINDOWS_MSI
  MACOS_DMG
  LINUX_DEB
  LINUX_RPM
  ARCHIVE
}

enum NetworkType {
  WiFi
  Mobile
  Ethernet
}

model Branch {
  uuid          String         @id @default(uuid())
  division      String
  code          String
  rrs           String
  name          String
  status        Int
  city          String
  address       String
  last_update   DateTime
  latitude      Float
  longitude     Float
  totalArea     Int
  tradingArea   Int
  warehouseArea Int
  type          String
  typeOfDist    String?
  images        BranchImage[]
  devices       Devices[]
  printService  PrintService[] @relation("BranchPrint")
  rk            RK[]
  supplyDocs    SupplyDocs[]   @relation("SupplyDocs_Branch")
  userData      UserData[]
  shops         Shop[]
  shopReserves  ShopReserve[] @relation("ShopReserveBranch")
  cleaningDocuments CleaningDocument[] @relation("CleaningBranch")
}

model Group {
  uuidPosition      String
  name              String            @unique
  uuid              String            @id @default(uuid())
  groupToolAccesses GroupToolAccess[]
  positions         Position[]
}

model Position {
  groupUuid            String
  name                 String               @unique
  uuid                 String               @id @default(uuid())
  group                Group                @relation(fields: [groupUuid], references: [uuid])
  positionToolAccesses PositionToolAccess[]
  userData             UserData[]
}

model Type {
  id                     String         @id @default(uuid())
  model_uuid             String
  chapter                String
  name                   String
  colorHex               String?
  parent_type            String?
  parent                 Type?          @relation("TypeHierarchy", fields: [parent_type], references: [id], onDelete: Cascade)
  children               Type[]          @relation("TypeHierarchy")
  sortOrder              Int            @default(0)
  Media                  Media[]        @relation("TypeMedia")
  rk_approvalStatus      RKAttachment[] @relation("RK_approvalStatus")
  rk_typeStructure       RKAttachment[] @relation("RK_typeStructure")
  roc_statusContract     Roc[]          @relation("Roc_statusContract")
  roc_typeContract       Roc[]          @relation("Roc_typeContract")
  SupplyDocsPTiU         SupplyDocs[]   @relation("SupplyDocs_PTiU")
  SupplyDocsRequirements SupplyDocs[]   @relation("SupplyDocs_Requirements")
  Tool                   Tool           @relation(fields: [model_uuid], references: [id])
  shops                  Shop[]
  correspondenceSenderTypes      Correspondence[]  @relation("CorrespondenceSenderType")
  correspondenceSenderSubTypes   Correspondence[]  @relation("CorrespondenceSenderSubType")
  correspondenceSenderSubSubTypes Correspondence[] @relation("CorrespondenceSenderSubSubType")
  correspondenceDocumentTypes    Correspondence[]  @relation("CorrespondenceDocumentType")
  managerStatuses                Manager[]          @relation("ManagerStatus")
  trainingStatuses               TrainingProgress[] @relation("TrainingStatus")
  trainingTypes                  TrainingProgram[]   @relation("TrainingType")
  employmentChangeTypes          EmploymentHistory[] @relation("EmploymentChangeType")
  homeworkStatuses               HomeworkStatus[]    @relation("HomeworkStatus")

  @@index([parent_type])
  @@index([model_uuid, chapter])
  @@index([model_uuid, chapter, sortOrder])
  @@index([parent_type, sortOrder])
}

model Tool {
  id                   String               @id @default(uuid())
  parent_id            String?
  name                 String
  icon                 String
  link                 String
  description          String?
  order                Int                  @default(1)
  included             Boolean?             @default(true)
  groupToolAccesses    GroupToolAccess[]
  Notifications        Notifications[]
  positionToolAccesses PositionToolAccess[]
  types                Type[]
  userToolAccesses     UserToolAccess[]
}

model User {
  id                     String                     @id @default(uuid())
  name                   String
  email                  String                     @unique
  position               String
  branch                 String
  feedbackResponses      FeedbackResponse[]
  image                  String?
  login                  String                     @unique
  updatedAt              DateTime                   @updatedAt
  role                   Role                       @default(EMPLOYEE)
  telegramChatId         String?                    @unique
  telegramLinkToken      String?                    @unique
  telegramUsername       String?
  bookmarks              Bookmarks[]
  correspondences        Correspondence[]              @relation("CorrespondenceUser")
  correspondenceResponsible Correspondence[]          @relation("CorrespondenceResponsible")
  attachments            CorrespondenceAttachment[]
  MediaAdd               Media[]                    @relation("Media_UserAdd")
  MediaUpdated           Media[]                    @relation("Media_UserUpdated")
  MediaAttachment        MediaAttachment[]
  meterReadings          MeterReading[]
  news                   News[]
  Notifications_Receiver Notifications[]            @relation("receiver")
  Notifications_Sender   Notifications[]            @relation("sender")
  RKAdded                RK[]                       @relation("RK_UserAdd")
  RKUpdated              RK[]                       @relation("RK_UserUpdated")
  RKAttachment           RKAttachment[]
  RocAdded               Roc[]                      @relation("Roc_UserAdd")
  RocUpdated             Roc[]                      @relation("Roc_UserUpdated")
  RocAttachment          RocAttachment[]
  Slider_Add             Slider[]                   @relation("added")
  Slider_Updated         Slider[]                   @relation("updated")
  AddedSupplyDocs        SupplyDocs[]               @relation("SupplyDocs_AddedBy")
  SupplyDocs             SupplyDocs[]               @relation("SupplyDocs_SettlementSpecialist")
  SupplyDocsAttachments  SupplyDocsAttachment[]
  UserSettings           UserSettings[]
  userToolAccesses       UserToolAccess[]
  MerchAttachments       MerchAttachment[]
  auditLogs              AuditLog[]
  shops                  Shop[]
  shopReserves           ShopReserve[] @relation("ShopReserveRequester")
  comments               Comment[] @relation("CommentSender")
  safetyJournalChats     SafetyJournalChat[] @relation("SafetyJournalChatChecker")
  safetyJournalMessages  SafetyJournalChatMessage[] @relation("SafetyJournalChatMessageSender")
  scanSessions           ScanSession[]
  pollsCreated           Poll[]        @relation("PollCreator")
  pollVotes              PollVote[]    @relation("PollVoter")
  knowledgeArticlesAuthored KnowledgeArticle[] @relation("KnowledgeArticleAuthor")
  knowledgeArticlesUpdated  KnowledgeArticle[] @relation("KnowledgeArticleUpdater")
  cleaningDocuments         CleaningDocument[] @relation("CleaningDocumentUploader")
  knowledgeArticleVersions  KnowledgeArticleVersion[] @relation("KnowledgeArticleVersionCreator")
  knowledgeAttachments      KnowledgeAttachment[] @relation("KnowledgeAttachmentUploader")
  knowledgeComments         KnowledgeComment[] @relation("KnowledgeCommentAuthor")
  knowledgeFavorites        KnowledgeFavorite[] @relation("KnowledgeFavoriteUser")
  manager                   Manager?
  homeworkChecker           HomeworkStatus[] @relation("HomeworkChecker")
}

model UserData {
  uuid        String   @id @default(uuid())
  birthday    DateTime
  fio         String
  code        String
  branch_uuid String
  positionId  String
  email       String   @unique
  status      String
  start_date  DateTime
  end_date    DateTime
  last_update DateTime @updatedAt
  branch      Branch   @relation(fields: [branch_uuid], references: [uuid])
  position    Position @relation(fields: [positionId], references: [uuid])
}

model UserSettings {
  id        String @id @default(uuid())
  userId    String
  parameter String
  value     String
  type      String
  user      User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, parameter])
}

model ScanSession {
  id          String       @id @default(uuid())
  userId      String
  printerIp   String
  printerPort Int
  folderName  String
  startedAt   DateTime     @default(now())
  stoppedAt   DateTime?
  status      String       @default("active")
  user        User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  files       ScannedFile[]

  @@index([userId])
  @@index([startedAt])
}

model ScannedFile {
  id            String      @id @default(uuid())
  scanSessionId String
  fileName      String
  filePath      String
  fileSize      Int
  scannedAt     DateTime    @default(now())
  scanSession   ScanSession @relation(fields: [scanSessionId], references: [id], onDelete: Cascade)

  @@index([scanSessionId])
}

model Printer {
  id          String   @id @default(uuid())
  ip          String
  port        Int      @default(9100)
  name        String?
  vendor      String?
  model       String?
  hasScanner  Boolean  @default(false)
  scannerType String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([ip, port])
  @@index([ip])
  @@index([hasScanner])
}

model Devices {
  id           String   @id @default(uuid())
  createdAt    DateTime @default(now())
  lastSeen     DateTime @default(now())
  vendor       String
  name         String
  timeFrom     String   @default("08:00")
  timeUntil    String   @default("22:00")
  network      String
  number       String
  app          String
  os           String
  macAddress   String?
  branchId     String
  branch       Branch   @relation(fields: [branchId], references: [uuid])
  userEmail    String?
}

model Notifications {
  id         String                @id @default(uuid())
  type       NotificationType
  channel    NotificationChannel[]
  action     Json?
  title      String
  message    String
  senderId   String
  receiverId String
  read       Boolean               @default(false)
  toolId     String?
  priority   NotificationPriority  @default(MEDIUM)
  expiresAt  DateTime?
  createdAt  DateTime              @default(now())
  updatedAt  DateTime              @updatedAt
  receiver   User                  @relation("receiver", fields: [receiverId], references: [id])
  sender     User                  @relation("sender", fields: [senderId], references: [id])
  tool       Tool?                 @relation(fields: [toolId], references: [id])

  @@index([receiverId])
  @@index([read])
  @@index([createdAt])
  @@index([senderId])
  @@index([toolId])
}

model News {
  id          String   @id @default(uuid())
  name        String
  description String
  userId      String
  createdAt   DateTime @default(now())
  user        User     @relation(fields: [userId], references: [id])
}

model Bookmarks {
  id         String  @id @default(uuid())
  name       String
  url        String  @unique
  userId     String
  order      Int     @default(0)
  user       User    @relation(fields: [userId], references: [id])
}

model Poll {
  id          String      @id @default(uuid())
  question    String
  isActive    Boolean     @default(true)
  startDate   DateTime?
  endDate     DateTime?
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  createdById String
  createdBy   User        @relation("PollCreator", fields: [createdById], references: [id])
  options     PollOption[]
  votes       PollVote[]

  @@index([isActive])
  @@index([createdAt])
  @@index([startDate])
  @@index([endDate])
}

model PollOption {
  id        String     @id @default(uuid())
  pollId    String
  poll      Poll       @relation(fields: [pollId], references: [id], onDelete: Cascade)
  text      String
  order     Int        @default(0)
  createdAt DateTime   @default(now())
  votes     PollVote[]

  @@index([pollId])
}

model PollVote {
  id        String      @id @default(uuid())
  pollId    String
  poll      Poll        @relation(fields: [pollId], references: [id], onDelete: Cascade)
  optionId  String
  option    PollOption  @relation(fields: [optionId], references: [id], onDelete: Cascade)
  userId    String
  user      User        @relation("PollVoter", fields: [userId], references: [id])
  createdAt DateTime    @default(now())

  @@unique([pollId, userId])
  @@index([pollId])
  @@index([optionId])
  @@index([userId])
}

model MeterReading {
  id          String   @id @default(uuid())
  createdAt   DateTime @default(now())
  date        DateTime
  userId      String
  indications Json
  user        User     @relation(fields: [userId], references: [id])
}

model Correspondence {
  id                    String                        @id @default(uuid())
  createdAt             DateTime                      @default(now())
  ReceiptDate           DateTime
  userAdd               String
  senderTypeId          String
  senderType            Type                          @relation("CorrespondenceSenderType", fields: [senderTypeId], references: [id])
  senderSubTypeId       String?
  senderSubType         Type?                        @relation("CorrespondenceSenderSubType", fields: [senderSubTypeId], references: [id])
  senderSubSubTypeId    String?
  senderSubSubType      Type?                        @relation("CorrespondenceSenderSubSubType", fields: [senderSubSubTypeId], references: [id])
  senderName            String
  documentTypeId        String
  documentType          Type                          @relation("CorrespondenceDocumentType", fields: [documentTypeId], references: [id])
  comments              String?
  responsibleId         String
  responsible           User                          @relation("CorrespondenceResponsible", fields: [responsibleId], references: [id])
  documentNumber        Int                           @default(autoincrement())
  trackNumber           String?
  user                  User                          @relation("CorrespondenceUser", fields: [userAdd], references: [id])
  attachments           CorrespondenceAttachment[]
  
  @@index([ReceiptDate])
  @@index([senderTypeId])
  @@index([documentTypeId])
  @@index([responsibleId])
  @@index([userAdd])
  @@index([documentNumber])
  @@index([trackNumber])
}

model CorrespondenceAttachment {
  id             String         @id @default(uuid())
  createdAt      DateTime       @default(now())
  record_id      String
  userAdd        String
  source         String
  correspondence Correspondence @relation(fields: [record_id], references: [id], onDelete: Cascade)
  user           User           @relation(fields: [userAdd], references: [id])
}

model Route {
  id         String     @id @default(uuid())
  name       String     @unique
  rrs        String
  contractor String
  createdAt  DateTime   @default(now())
  updatedAt  DateTime   @updatedAt
  filials    Filial[]
  days       RouteDay[]
}

model RouteDay {
  id        String   @id @default(uuid())
  day       DateTime @unique
  routeId   String
  createdAt DateTime @default(now())
  filials   Filial[]
  route     Route    @relation(fields: [routeId], references: [id], onDelete: Cascade)
}

model Filial {
  id         String    @id @default(uuid())
  name       String
  place      Int?
  accepted   Boolean   @default(false)
  feedback   String?
  routeId    String
  routeDayId String?
  updatedAt  DateTime  @updatedAt
  routeDay   RouteDay? @relation(fields: [routeDayId], references: [id], onDelete: Cascade)
  route      Route     @relation(fields: [routeId], references: [id], onDelete: Cascade)
  loaders    Loader[]
}

model Loader {
  id        String   @id @default(uuid())
  startTime DateTime
  endTime   DateTime
  filialId  String
  filial    Filial   @relation(fields: [filialId], references: [id], onDelete: Cascade)
}

model SupplyDocs {
  id                     String                 @id @default(uuid())
  createdAt              DateTime               @default(now())
  updatedAt              DateTime
  addedById              String
  inn                    Int
  counterParty           String
  demandsForPayment      String
  statusRequirements     String
  fileInvoicePayment     String
  costBranchId           String
  settlementSpecialistId String?
  statusOfPTiU           String
  filePTiU               String
  note                   String
  fileNote               String
  requirementNumber      String
  addedBy                User                   @relation("SupplyDocs_AddedBy", fields: [addedById], references: [id])
  costBranch             Branch                 @relation("SupplyDocs_Branch", fields: [costBranchId], references: [uuid])
  settlementSpecialist   User?                  @relation("SupplyDocs_SettlementSpecialist", fields: [settlementSpecialistId], references: [id])
  statusOfPTiUId         Type                   @relation("SupplyDocs_PTiU", fields: [statusOfPTiU], references: [id])
  statusRequirementsId   Type                   @relation("SupplyDocs_Requirements", fields: [statusRequirements], references: [id])
  supplyDocs             SupplyDocsAttachment[]
}

model SupplyDocsAttachment {
  id         String     @id @default(uuid())
  createdAt  DateTime   @default(now())
  userAdd    String
  source     String
  type       String
  recordId   String
  supplyDocs SupplyDocs @relation(fields: [recordId], references: [id])
  user       User       @relation(fields: [userAdd], references: [id])
}

model Media {
  id              String            @id @default(uuid())
  createdAt       DateTime          @default(now())
  updatedAt       DateTime?         @updatedAt
  userAddId       String
  userUpdatedId   String?
  name            String?
  information     String?
  urlMedia2       String?
  typeContentId   String?
  typeContent     Type?             @relation("TypeMedia", fields: [typeContentId], references: [id])
  userAdd         User              @relation("Media_UserAdd", fields: [userAddId], references: [id])
  userUpdated     User?             @relation("Media_UserUpdated", fields: [userUpdatedId], references: [id])
  MediaAttachment MediaAttachment[]
}

model MediaAttachment {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())
  userAddId String
  source    String
  type      String
  recordId  String
  media     Media    @relation(fields: [recordId], references: [id])
  userAdd   User     @relation(fields: [userAddId], references: [id])
}

model RK {
  id            String         @id @default(uuid())
  createdAt     DateTime       @default(now())
  updatedAt     DateTime?      @updatedAt
  userAddId     String
  userUpdatedId String
  branchId      String
  branch        Branch         @relation(fields: [branchId], references: [uuid])
  userAdd       User           @relation("RK_UserAdd", fields: [userAddId], references: [id])
  userUpdated   User           @relation("RK_UserUpdated", fields: [userUpdatedId], references: [id])
  rkAttachment  RKAttachment[]
}

model RKAttachment {
  id                 String         @id @default(uuid())
  createdAt          DateTime       @default(now())
  userAddId          String
  source             String
  type               String
  recordId           String
  sizeXY             String
  clarification      String
  agreedTo           DateTime?
  approvalStatusId   String?
  typeStructureId    String?
  typeAttachment     String
  parentAttachmentId String?
  approvalStatus     Type?          @relation("RK_approvalStatus", fields: [approvalStatusId], references: [id])
  parentAttachment   RKAttachment?  @relation("RKAttachment_Parent", fields: [parentAttachmentId], references: [id])
  childAttachments   RKAttachment[] @relation("RKAttachment_Parent")
  rk                 RK             @relation(fields: [recordId], references: [id], onDelete: Cascade)
  typeStructure      Type?          @relation("RK_typeStructure", fields: [typeStructureId], references: [id])
  userAdd            User           @relation(fields: [userAddId], references: [id])
}

model Slider {
  id          String    @id @default(uuid())
  addedById   String
  updatedById String?
  name        String
  category    String
  visible     Boolean   @default(false)
  timeVisible Float     @default(0)
  attachment  String
  startDate   DateTime?
  endDate     DateTime?
  url         String    @default("https://dns-shop.ru/")
  add         Boolean   @default(false)
  sale        Boolean   @default(false)
  order       Int       @default(1)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  addedBy     User      @relation("added", fields: [addedById], references: [id])
  updatedBy   User?     @relation("updated", fields: [updatedById], references: [id])
}

model Doc {
  id              String    @id @default(uuid())
  fullName        String
  name            String
  address         String
  inn             String
  ogrn            String
  kpp             String
  taxationSystem  String
  phone           String
  email           String
  siEgrul         String
  statusCode      Int
  deStatusCode    String
  liquidationDate DateTime
  successorName   String
  successorINN    String
  updatedAt       DateTime? @updatedAt
  roc             Roc[]
}

model Roc {
  id                     String          @id @default(uuid())
  createdAt              DateTime        @default(now())
  updatedAt              DateTime?       @updatedAt
  userAddId              String
  userUpdatedId          String
  terminationLetter      Boolean         @default(false)
  dateSendCorrespondence DateTime
  docId                  String
  shelfLife              Int
  name                   String
  typeTerm               RocTypeByTerm
  contractNumber         String
  dateContract           DateTime
  agreedTo               DateTime
  typeContractId         String
  statusContractId       String
  terminationСonditions  String
  peculiarities          String
  folderNo               String
  doc                    Doc             @relation(fields: [docId], references: [id])
  statusContract         Type            @relation("Roc_statusContract", fields: [statusContractId], references: [id])
  typeContract           Type            @relation("Roc_typeContract", fields: [typeContractId], references: [id])
  userAdd                User            @relation("Roc_UserAdd", fields: [userAddId], references: [id])
  userUpdated            User            @relation("Roc_UserUpdated", fields: [userUpdatedId], references: [id])
  rocAttachment          RocAttachment[]
}

model RocAttachment {
  id         String   @id @default(uuid())
  createdAt  DateTime @default(now())
  source     String
  type       String
  recordId   String
  userAddId  String
  additional Boolean  @default(false)
  roc        Roc      @relation(fields: [recordId], references: [id])
  userAdd    User     @relation(fields: [userAddId], references: [id])
}

model PrintService {
  id        String   @id @default(uuid())
  branchId  String
  tovarName String
  tovarCode Int
  price     Float
  createdAt DateTime
  updatedAt DateTime
  brand     String
  tovarId   String
  format    Int
  branch    Branch   @relation("BranchPrint", fields: [branchId], references: [uuid])
}

model App {
  id            String        @id @default(uuid())
  name          String
  category      AppCategory
  appType       AppType
  description   String?
  icon          String?
  isActive      Boolean       @default(true)
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  versions      AppVersion[]
  
  @@index([category])
  @@index([appType])
  @@index([isActive])
  @@index([createdAt])
}

model AppVersion {
  id          String   @id @default(uuid())
  appId       String
  version     String
  fileName    String
  filePath    String
  fileSize    Int
  description String?
  isActive    Boolean  @default(true)
  downloadCount Int    @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  app         App      @relation(fields: [appId], references: [id], onDelete: Cascade)
  
  @@index([appId])
  @@index([version])
  @@index([isActive])
  @@index([createdAt])
}

model RadioStream {
  id               String    @id @default(cuid())
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  name             String
  branchTypeOfDist String
  frequencySongs   Int
  fadeInDuration   Int
  volumeLevel      Int
  startDate        DateTime
  endDate          DateTime?
  attachment       String?
  isActive         Boolean   @default(true)

  @@map("RadioStream")
}

model Merch {
  id          String   @id @default(uuid())
  parentId    String?
  parent      Merch?   @relation("CategoryHierarchy", fields: [parentId], references: [id], onDelete: Cascade)
  children    Merch[]  @relation("CategoryHierarchy")
  name        String
  description String?
  isActive    Boolean  @default(true)
  sortOrder   Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  layer       Int
  attachments MerchAttachment[]

  @@index([parentId])
  @@index([layer])
  @@index([isActive])
  @@index([parentId, layer])
  @@index([sortOrder])
  @@index([parentId, sortOrder])
}

model MerchAttachment {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())
  userAddId String
  source    String
  type      String
  recordId  String
  sortOrder Int      @default(0)
  merch     Merch    @relation(fields: [recordId], references: [id], onDelete: Cascade)
  userAdd   User     @relation(fields: [userAddId], references: [id])

  @@index([recordId])
  @@index([recordId, sortOrder])
  @@index([type])
}

model MerchTgUser {
  id        String   @id @default(uuid())
  userId    Int      @unique
  username  String?
  firstName String?
  lastName  String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  isActive  Boolean  @default(true)
  stats     MerchTgUserStats[]

  @@index([isActive])
}

model MerchTgUserStats {
  id        String       @id @default(uuid())
  userId    String
  action    String
  details   String?
  timestamp DateTime     @default(now())
  user      MerchTgUser @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([action])
  @@index([timestamp])
  @@index([userId, action])
  @@index([action, timestamp])
}

enum ShopStatus {
  ACTIVE
  SOLD
  ARCHIVED
  MODERATION
}

enum ItemCondition {
  NEW
  EXCELLENT
  GOOD
  SATISFACTORY
  POOR
}

model Shop {
  id          String      @id @default(uuid())
  title       String
  description String?     @db.Text
  categoryId  String
  category    Type        @relation(fields: [categoryId], references: [id])
  branchId    String
  branch      Branch      @relation(fields: [branchId], references: [uuid])
  status      ShopStatus  @default(ACTIVE)
  userId      String
  user        User        @relation(fields: [userId], references: [id])
  quantity    Int         @default(1)
  article     String?
  condition   ItemCondition @default(GOOD)
  views       Int         @default(0)
  isPromoted  Boolean     @default(false)
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  publishedAt DateTime?
  attachments ShopAttachment[]
  reserves    ShopReserve[]

  @@index([categoryId])
  @@index([branchId])
  @@index([status])
  @@index([userId])
  @@index([createdAt])
  @@index([status, createdAt])
  @@index([isPromoted, status])
}

model ShopAttachment {
  id        String   @id @default(uuid())
  shopId    String
  shop      Shop     @relation(fields: [shopId], references: [id], onDelete: Cascade)
  source    String
  sortOrder Int      @default(0)
  isMain    Boolean  @default(false)
  createdAt DateTime @default(now())

  @@index([shopId])
  @@index([shopId, sortOrder])
}

model ShopReserve {
  id          String   @id @default(uuid())
  shopId      String
  shop        Shop     @relation(fields: [shopId], references: [id], onDelete: Cascade)
  requesterId String
  requester   User     @relation("ShopReserveRequester", fields: [requesterId], references: [id], onDelete: Cascade)
  branchId    String?
  branch      Branch?   @relation("ShopReserveBranch", fields: [branchId], references: [uuid], onDelete: SetNull)
  quantity    Int
  status      String   @default("PENDING")
  shipmentDocNumber String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  approvedAt  DateTime?
  completedAt DateTime?

  @@index([shopId])
  @@index([requesterId])
  @@index([status])
}

model Comment {
  id         String   @id @default(uuid())
  entityType String
  entityId   String
  senderId   String
  sender     User     @relation("CommentSender", fields: [senderId], references: [id], onDelete: Cascade)
  message    String   @db.Text
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  readAt     DateTime?
  parentId   String?
  parent     Comment? @relation("CommentReplies", fields: [parentId], references: [id], onDelete: Cascade)
  replies    Comment[] @relation("CommentReplies")

  @@index([entityType, entityId])
  @@index([senderId])
  @@index([entityType, entityId, createdAt])
  @@index([parentId])
}

model SafetyJournalChat {
  id          String                      @id @default(uuid())
  branchId    String
  checkerId   String
  checker     User                        @relation("SafetyJournalChatChecker", fields: [checkerId], references: [id], onDelete: Cascade)
  createdAt   DateTime                    @default(now())
  updatedAt   DateTime                    @updatedAt
  messages    SafetyJournalChatMessage[]

  @@unique([branchId, checkerId])
  @@index([branchId])
  @@index([checkerId])
  @@index([updatedAt])
}

model SafetyJournalChatMessage {
  id            String                   @id @default(uuid())
  chatId        String
  chat          SafetyJournalChat        @relation(fields: [chatId], references: [id], onDelete: Cascade)
  senderId      String
  sender        User                     @relation("SafetyJournalChatMessageSender", fields: [senderId], references: [id], onDelete: Cascade)
  message       String                   @db.Text
  readAt        DateTime?
  createdAt     DateTime                 @default(now())
  updatedAt     DateTime                 @updatedAt
  isEdited      Boolean                  @default(false)
  quotedMessageId String?
  quotedMessage   SafetyJournalChatMessage? @relation("QuotedMessage", fields: [quotedMessageId], references: [id], onDelete: SetNull)
  replies         SafetyJournalChatMessage[] @relation("QuotedMessage")
  attachments   ChatMessageAttachment[]

  @@index([chatId])
  @@index([senderId])
  @@index([chatId, createdAt])
  @@index([quotedMessageId])
}

model ChatMessageAttachment {
  id            String                 @id @default(uuid())
  messageId     String
  message       SafetyJournalChatMessage @relation(fields: [messageId], references: [id], onDelete: Cascade)
  fileName      String
  fileUrl       String
  fileSize      Int?
  mimeType      String?
  uploadedAt    DateTime               @default(now())

  @@index([messageId])
}

enum FeedbackStatus {
  NEW
  IN_PROGRESS
  RESOLVED
  REJECTED
}

enum FeedbackPriority {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

model Feedback {
  id          String          @id @default(uuid())
  tool        String
  userId      String?
  email       String
  text        String
  photos      String[]        @default([])
  metadata    Json?
  createdAt   DateTime        @default(now())
  isRead      Boolean         @default(false)
  readAt      DateTime?
  readBy      String?
  status      FeedbackStatus  @default(NEW)
  priority    FeedbackPriority @default(MEDIUM)
  tags        String[]        @default([])
  assignedTo  String?
  pinned      Boolean         @default(false)
  responses   FeedbackResponse[]
  
  @@index([tool])
  @@index([createdAt])
  @@index([isRead])
  @@index([tool, isRead])
  @@index([status])
  @@index([priority])
  @@index([assignedTo])
  @@index([pinned])
  @@index([email])
}

model FeedbackResponse {
  id          String   @id @default(uuid())
  feedbackId  String
  feedback    Feedback @relation(fields: [feedbackId], references: [id], onDelete: Cascade)
  userId      String
  user        User     @relation(fields: [userId], references: [id])
  text        String
  createdAt   DateTime @default(now())
  sentAt      DateTime?
  sentEmail   Boolean  @default(false)
  
  @@index([feedbackId])
  @@index([createdAt])
  @@index([userId])
}

model GroupToolAccess {
  id          String      @id @default(uuid())
  toolId      String
  accessLevel AccessLevel
  groupId     String
  group       Group       @relation(fields: [groupId], references: [uuid])
  tool        Tool        @relation(fields: [toolId], references: [id])

  @@unique([groupId, toolId], name: "groupId_toolId")
}

model PositionToolAccess {
  id          String      @id @default(uuid())
  toolId      String
  accessLevel AccessLevel
  positionId  String
  position    Position    @relation(fields: [positionId], references: [uuid])
  tool        Tool        @relation(fields: [toolId], references: [id])

  @@unique([positionId, toolId], name: "positionId_toolId")
}

model UserToolAccess {
  id          String      @id @default(uuid())
  userId      String
  toolId      String
  accessLevel AccessLevel
  validFrom   DateTime?
  validUntil  DateTime?
  isTemporary Boolean    @default(false)
  grantedBy   String?
  reason      String?
  tool        Tool        @relation(fields: [toolId], references: [id])
  user        User        @relation(fields: [userId], references: [id])

  @@unique([userId, toolId], name: "userId_toolId")
}

model BranchImage {
  id          String @id @default(uuid())
  link        String
  branch_uuid String
  branch      Branch @relation(fields: [branch_uuid], references: [uuid])
}

model AuditLog {
  id          String   @id @default(uuid())
  userId      String
  userEmail   String?
  action      String
  entityType  String?
  entityId    String?
  details     Json?
  ipAddress   String?
  userAgent   String?
  timestamp   DateTime @default(now())
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([action])
  @@index([entityType])
  @@index([timestamp])
  @@index([userId, timestamp])
}

model TrassirDoorLog {
  id        String   @id @default(uuid())
  doorId    Int
  doorName  String?
  personName String?
  tgId      Int?
  openedAt  DateTime @default(now())

  @@index([doorId])
  @@index([tgId])
  @@index([openedAt])
  @@map("TrassirDoorLog")
}

model KnowledgeArticle {
  id          String   @id @default(uuid())
  title       String
  slug        String   @unique
  content     String   @db.Text
  excerpt     String?
  icon        String?
  categoryId  String?
  category    KnowledgeCategory? @relation(fields: [categoryId], references: [id])
  authorId    String
  author      User     @relation("KnowledgeArticleAuthor", fields: [authorId], references: [id])
  updatedById String?
  updatedBy   User?    @relation("KnowledgeArticleUpdater", fields: [updatedById], references: [id])
  tags        String[]
  isPinned    Boolean  @default(false)
  isPublished Boolean  @default(true)
  viewCount   Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  publishedAt DateTime?
  attachments KnowledgeAttachment[]
  comments    KnowledgeComment[]
  versions    KnowledgeArticleVersion[]
  favorites   KnowledgeFavorite[]
  
  @@index([categoryId])
  @@index([authorId])
  @@index([slug])
  @@index([tags])
  @@index([isPublished])
  @@index([isPinned])
  @@index([createdAt])
  @@index([viewCount])
}

model KnowledgeCategory {
  id          String   @id @default(uuid())
  name        String
  description String?
  icon        String?
  color       String?
  parentId    String?
  parent      KnowledgeCategory? @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children    KnowledgeCategory[] @relation("CategoryHierarchy")
  order       Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  articles    KnowledgeArticle[]
  
  @@index([parentId])
  @@index([order])
}

model KnowledgeArticleVersion {
  id          String   @id @default(uuid())
  articleId   String
  article     KnowledgeArticle @relation(fields: [articleId], references: [id], onDelete: Cascade)
  version     Int
  title       String
  content     String   @db.Text
  excerpt     String?
  createdById String
  createdBy   User     @relation("KnowledgeArticleVersionCreator", fields: [createdById], references: [id])
  changeNote  String?
  createdAt   DateTime @default(now())
  
  @@unique([articleId, version])
  @@index([articleId])
  @@index([createdAt])
}

model KnowledgeAttachment {
  id          String   @id @default(uuid())
  articleId   String
  article     KnowledgeArticle @relation(fields: [articleId], references: [id], onDelete: Cascade)
  fileName    String
  fileUrl     String
  fileSize    Int
  mimeType    String
  uploadedById String
  uploadedBy   User     @relation("KnowledgeAttachmentUploader", fields: [uploadedById], references: [id])
  createdAt   DateTime @default(now())
  
  @@index([articleId])
}

model KnowledgeComment {
  id          String   @id @default(uuid())
  articleId   String
  article     KnowledgeArticle @relation(fields: [articleId], references: [id], onDelete: Cascade)
  userId      String
  user        User     @relation("KnowledgeCommentAuthor", fields: [userId], references: [id])
  content     String   @db.Text
  parentId    String?
  parent      KnowledgeComment? @relation("CommentReplies", fields: [parentId], references: [id])
  replies     KnowledgeComment[] @relation("CommentReplies")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([articleId])
  @@index([userId])
  @@index([parentId])
}

model KnowledgeFavorite {
  id          String   @id @default(uuid())
  articleId   String
  article     KnowledgeArticle @relation(fields: [articleId], references: [id], onDelete: Cascade)
  userId      String
  user        User     @relation("KnowledgeFavoriteUser", fields: [userId], references: [id], onDelete: Cascade)
  createdAt   DateTime @default(now())
  
  @@unique([articleId, userId])
  @@index([userId])
}

model Manager {
  id                    String              @id @default(uuid())
  userId                String               @unique
  user                  User                 @relation(fields: [userId], references: [id], onDelete: Cascade)
  statusId              String
  status                Type                 @relation("ManagerStatus", fields: [statusId], references: [id])
  branchCount           Int?
  employeeCount         Int?
  employmentHistory     EmploymentHistory[]
  trainingProgress      TrainingProgress[]
  homeworkStatuses      HomeworkStatus[]
  createdAt             DateTime             @default(now())
  updatedAt             DateTime             @updatedAt
  
  @@index([userId])
  @@index([statusId])
}

model EmploymentHistory {
  id            String                @id @default(uuid())
  managerId     String
  manager       Manager               @relation(fields: [managerId], references: [id], onDelete: Cascade)
  changeTypeId  String
  changeType    Type                  @relation("EmploymentChangeType", fields: [changeTypeId], references: [id])
  fromBranchId  String?
  toBranchId    String?
  fromPosition  String?
  toPosition    String?
  changeDate    DateTime
  notes         String?
  createdAt     DateTime              @default(now())
  
  @@index([managerId])
  @@index([changeDate])
  @@index([changeTypeId])
}

model TrainingProgram {
  id            String              @id @default(uuid())
  name          String
  typeId        String
  type          Type                @relation("TrainingType", fields: [typeId], references: [id])
  parentId      String?
  parent        TrainingProgram?    @relation("ProgramHierarchy", fields: [parentId], references: [id], onDelete: Cascade)
  children      TrainingProgram[]   @relation("ProgramHierarchy")
  order         Int                 @default(0)
  isRequired    Boolean             @default(false)
  createdAt     DateTime            @default(now())
  updatedAt     DateTime            @updatedAt
  progress      TrainingProgress[]
  homework      HomeworkStatus[]

  @@index([parentId])
  @@index([typeId])
  @@index([isRequired])
}

model TrainingProgress {
  id                String              @id @default(uuid())
  managerId         String
  manager           Manager             @relation(fields: [managerId], references: [id], onDelete: Cascade)
  trainingProgramId String
  trainingProgram   TrainingProgram    @relation(fields: [trainingProgramId], references: [id], onDelete: Cascade)
  statusId          String
  status            Type                @relation("TrainingStatus", fields: [statusId], references: [id])
  completionDate    DateTime?
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt
  
  @@unique([managerId, trainingProgramId])
  @@index([managerId])
  @@index([statusId])
}

model HomeworkStatus {
  id                String              @id @default(uuid())
  managerId         String
  manager           Manager             @relation(fields: [managerId], references: [id], onDelete: Cascade)
  trainingProgramId String
  trainingProgram   TrainingProgram     @relation(fields: [trainingProgramId], references: [id], onDelete: Cascade)
  statusId          String
  status            Type                @relation("HomeworkStatus", fields: [statusId], references: [id])
  checkerId         String?
  checker           User?               @relation("HomeworkChecker", fields: [checkerId], references: [id])
  submissionDate    DateTime?
  checkDate         DateTime?
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt
  @@unique([managerId, trainingProgramId])
  @@index([managerId])
  @@index([statusId])
}

model CleaningDocument {
  id            String          @id @default(uuid())
  branchId     String
  branch       Branch           @relation("CleaningBranch", fields: [branchId], references: [uuid], onDelete: Cascade)
  fileName     String
  fileUrl      String
  fileSize     Int
  mimeType     String
  uploadedById String
  uploadedBy   User             @relation("CleaningDocumentUploader", fields: [uploadedById], references: [id])
  uploadedAt   DateTime         @default(now())
  
  @@index([branchId])
  @@index([uploadedById])
  @@index([uploadedAt])
}
